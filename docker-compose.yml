services:
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: Praksis-server
    environment:
      NODE_ENV: production
      PORT: 3001
      TOKEN_TTL_MS: 1800000
      UPLOAD_CHUNK_LIMIT_BYTES: 8388608
      PER_UPLOAD_MAX_BYTES: 3221225472
      INFLIGHT_TTL_MS: 1800000
    volumes:
      - server_uploads:/app/uploads
      - server_staging:/app/staging
      - server_data:/app/data
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped
    init: true
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"fetch('http://127.0.0.1:3001/health').then(r=>{if(!r.ok)process.exit(1)}).catch(()=>process.exit(1))\"",
        ]
      interval: 30s
      timeout: 5s
      retries: 3

  web:
    image: nginx:alpine
    container_name: Praksis-web
    ports:
      - "8080:80"
    volumes:
      - ./web:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      server:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - NET_BIND_SERVICE
      - SETGID
      - SETUID
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/ >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  server_uploads:
  server_staging:
  server_data:
